<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tekomap</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/frontend/css/style.css" />

  <style>
    /* Estilos Gerais */
    body {
      margin: 0;
      font-family: sans-serif;
    }

    /* Header */
   
  header{
      width: 100%;
      height: 14vh;
      background-color: #eddaa6;
      color: white;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
      border-bottom: 4px solid #8b7653;
      display: flex;
      align-items: center;
      justify-content: space-between;
}


    

    header button {
      padding: 8px 16px;
      background-color: #b56a45;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      align-items: center;
      margin-right: 2vh;
    }

    header button:hover {
      background-color: #8b3d10;
    }

    /* Notificação de Coordenadas */
    .notificacao-coordenada {
      position: fixed;
      top: 110px;
      right: 20px;
      background-color: #ffffff;
      color: #333;
      border-left: 5px solid #b56a45;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      padding: 12px 16px;
      border-radius: 6px;
      z-index: 9999;
      max-width: 300px;
    }

    .notificacao-coordenada .fechar {
      position: absolute;
      top: 6px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      color: #888;
      cursor: pointer;
    }

    .notificacao-coordenada .fechar:hover {
      color: #000;
    }

    /* Mapa */
    #map {
      height: 600px;
      width: 100%;
    }

    #coordenadas {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      z-index: 1000;
    }

    /* Container Principal */
    #map-container {
      display: flex;
      position: relative;
    }

    /* Barra de Pesquisa */
    #pesquisa {
      width: 50vh;
      padding: 10vh;
      background: #8b7653;
      border-left: 1px solid #ddd;
    }

    #pesquisa h2 {
      font-size: 4vh;
      color: #372a07;
      margin-top: 0;
    }

    #pesquisa input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #pesquisa button {
      padding: 8px 12px;
      background-color: #372a07;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }

    #pesquisa button:hover {
      background-color: #8b3d10;
    }

    
  </style>
</head>
<body>

  <header>
    <a href="index.html">
      <img height="90vh" id="logo" src="/frontend/images/logo2.png" alt="Logo TEKOMAP" />
    </a>
    <button onclick="window.location.href='quiz.html'">Quiz</button>
  </header>

  <div id="map-container">
    <div id="map"></div>
    <div id="pesquisa">
      <h2>Pesquisar</h2>
      <input type="text" id="searchInput" placeholder="Digite nome ou etnia..." />
      <button id="searchButton">Buscar</button>
      <button id="resetButton">Limpar</button>
    </div>
    <div id="coordenadas">Passe o mouse no mapa</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Inicialização do mapa
    const map = L.map('map').setView([-29.5, -53], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Variáveis globais
    let markersLayer = L.layerGroup().addTo(map);
    let allTerritories = [];

    // Função para criar marcador personalizado
    function createMarker(feature, latlng) {
      const iconHtml = `
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 16 16" class="custom-marker">
          <path fill="#cd483e" d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10"/>
          <circle cx="8" cy="6" r="3" fill="#b31412"/>
        </svg>
      `;

      const customIcon = L.divIcon({
        className: '',
        html: iconHtml,
        iconSize: [30, 30],
        iconAnchor: [15, 30]
      });

      const marker = L.marker(latlng, { icon: customIcon });
      
      const props = feature.properties || {};
      let conteudoPopup = `
        <strong>${props.nome || 'Sem nome'}</strong><br>
        ${props.populacao ? `População: ${props.populacao}<br>` : ""}
        ${props.etnia ? `Etnia: ${props.etnia}<br>` : ""}
        ${props.area_ha ? `Área: ${props.area_ha} ha` : ""}
      `;
      
      marker.bindPopup(conteudoPopup);
      return marker;
    }

    // Função para mostrar todos os territórios
    function showAllTerritories() {
      markersLayer.clearLayers();
      allTerritories.forEach(territory => {
        const marker = createMarker(territory, L.latLng(
          territory.geometry.coordinates[1],
          territory.geometry.coordinates[0]
        ));
        markersLayer.addLayer(marker);
      });
    }

    // Função para filtrar territórios
    function filterTerritories(searchTerm) {
      if (!searchTerm) {
        showAllTerritories();
        return;
      }
      
      markersLayer.clearLayers();
      const searchLower = searchTerm.toLowerCase();
      
      const filtered = allTerritories.filter(territory => {
        const props = territory.properties || {};
        return (
          (props.nome && props.nome.toLowerCase().includes(searchLower)) ||
          (props.etnia && props.etnia.toLowerCase().includes(searchLower))
        );
      });
      
      // Adiciona marcadores filtrados
      filtered.forEach(territory => {
        const marker = createMarker(territory, L.latLng(
          territory.geometry.coordinates[1],
          territory.geometry.coordinates[0]
        ));
        markersLayer.addLayer(marker);
        
        // Abre popup automaticamente se houver apenas um resultado
        if (filtered.length === 1) {
          marker.openPopup();
        }
      });
      
      // Ajusta o zoom para mostrar todos os resultados
      if (filtered.length > 0) {
        const bounds = L.latLngBounds(
          filtered.map(t => [t.geometry.coordinates[1], t.geometry.coordinates[0]])
        );
        map.fitBounds(bounds, { padding: [50, 50] });
      } else {
        alert("Nenhum território encontrado com esse critério de busca.");
      }
    }

    // Carregar dados GeoJSON
    function loadTerritories() {
      fetch('/frontend/terras-rs.geojson')
        .then(response => {
          if (!response.ok) throw new Error("Arquivo GeoJSON não encontrado");
          return response.json();
        })
        .then(geojson => {
          allTerritories = geojson.features;
          showAllTerritories();
        })
        .catch(error => {
          console.error("Erro ao carregar GeoJSON:", error);
          alert("Erro ao carregar os dados dos territórios.");
        });
    }

    // Mostrar coordenadas com o mouse
    function setupCoordinateDisplay() {
      const coordBox = document.getElementById('coordenadas');
      map.on('mousemove', function(e) {
        const lat = e.latlng.lat.toFixed(5);
        const lng = e.latlng.lng.toFixed(5);
        coordBox.innerText = `Lat: ${lat}, Lng: ${lng}`;
      });
    }

    // Mostrar coordenadas ao clicar no mapa
    function setupClickCoordinates() {
      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(5);
        const lng = e.latlng.lng.toFixed(5);
        
        const existente = document.querySelector('.notificacao-coordenada');
        if (existente) existente.remove();

        const notificacao = document.createElement('div');
        notificacao.className = 'notificacao-coordenada';
        notificacao.innerHTML = `
          <button class="fechar" onclick="this.parentElement.remove()">&times;</button>
          <strong>Coordenadas:</strong><br>
          Latitude: ${lat}<br>
          Longitude: ${lng}
        `;

        document.body.appendChild(notificacao);
      });
    }

    // Configurar eventos de busca
    function setupSearchEvents() {
      document.getElementById('searchButton').addEventListener('click', function() {
        const searchTerm = document.getElementById('searchInput').value.trim();
        filterTerritories(searchTerm);
      });

      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          const searchTerm = document.getElementById('searchInput').value.trim();
          filterTerritories(searchTerm);
        }
      });

      document.getElementById('resetButton').addEventListener('click', function() {
        document.getElementById('searchInput').value = '';
        showAllTerritories();
        map.setView([-29.5, -53], 7);
      });
    }

    // Inicialização da aplicação
    function init() {
      setupCoordinateDisplay();
      setupClickCoordinates();
      setupSearchEvents();
      loadTerritories();
    }

    // Inicia a aplicação quando o DOM estiver carregado
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>